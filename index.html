<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8" />
    <title>å°ä¸­ç¾é£Ÿè©•åƒ¹ç³»çµ±</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        input, textarea, button {
            font-size: 16px;
        }
        #searchInput, #newPlaceInput {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
        }
        #placeList {
            list-style: none;
            padding: 0;
        }
        #placeList li {
            padding: 8px;
            border-bottom: 1px solid #ccc;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #placeList li:hover {
            background-color: #f0f0f0;
        }
        .deleteBtn {
            background-color: red;
            color: white;
            border: none;
            padding: 4px 8px;
            cursor: pointer;
        }
        .deleteBtn:hover {
            background-color: darkred;
        }
        .addBtn {
            background-color: green;
            color: white;
            border: none;
            padding: 8px 12px;
            margin-bottom: 20px;
            cursor: pointer;
        }
        .addBtn:hover {
            background-color: darkgreen;
        }
        #infoPanel {
            margin-top: 20px;
            display: none;
        }
        #reviewList {
            margin-top: 20px;
            list-style: none;
            padding: 0;
        }
        #reviewList li {
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f9f9f9;
            border-left: 4px solid #4caf50;
        }
        .highlight {
            background-color: yellow;
        }
        .thumbnail {
            max-width: 100px;
            max-height: 100px;
            display: block;
            margin-top: 10px;
        }
    </style>

    <!-- Firebase App (æ ¸å¿ƒ Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body>
    <h1>ğŸ± å°ä¸­ç¾é£Ÿè©•åƒ¹ç³»çµ±</h1>

    <input type="text" id="searchInput" placeholder="ğŸ” æœå°‹åº—å..." oninput="filterPlaces()" />
    <input type="text" id="newPlaceInput" placeholder="â• æ–°å¢é¤å»³åç¨±..." />
    <button class="addBtn" onclick="addPlace()">æ–°å¢é¤å»³</button>

    <ul id="placeList"></ul>

    <div id="infoPanel">
        <h2 id="selectedPlaceName"></h2>
        <label for="rating">è©•åˆ† (1~5)ï¼š</label>
        <input type="number" id="rating" min="1" max="5" /><br /><br />

        <label for="review">å¿ƒå¾—è¨˜éŒ„ï¼š</label><br />
        <textarea id="review" rows="4" cols="50"></textarea><br /><br />

        <label for="image">ä¸Šå‚³ç…§ç‰‡ï¼š</label>
        <input type="file" id="image" /><br /><br />

        <button onclick="saveReview()">å„²å­˜ç´€éŒ„</button>
    </div>

    <hr />
    <h2>ğŸ“– è©•åƒ¹ç´€éŒ„</h2>
    <ul id="reviewList"></ul>

    <script>
      // Firebase é…ç½®ï¼ˆè«‹æ›æˆä½ è‡ªå·±çš„ï¼‰
      const firebaseConfig = {
        apiKey: "AIzaSyAYRI7RzYurvjXIhwbOIwM6mHePzESiBAY",
        authDomain: "taichungfoodreview.firebaseapp.com",
        projectId: "taichungfoodreview",
        storageBucket: "taichungfoodreview.firebasestorage.app",
        messagingSenderId: "507968605081",
        appId: "1:507968605081:web:6fb36e1b21b9056338a108",
        measurementId: "G-RNTPBPECGT"
      };

      // åˆå§‹åŒ– Firebase
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      let places = [];
      let selectedPlace = null;
      let savedReviews = [];

      function highlightText(text, keyword) {
        if (!keyword) return text;
        const regex = new RegExp(`(${keyword})`, "gi");
        return text.replace(regex, '<span class="highlight">$1</span>');
      }

      function displayPlaces(list) {
        const listEl = document.getElementById("placeList");
        listEl.innerHTML = "";
        const keyword = document.getElementById("searchInput").value.toLowerCase();

        list.forEach((place) => {
          const li = document.createElement("li");

          const nameSpan = document.createElement("span");
          nameSpan.innerHTML = highlightText(place, keyword);
          nameSpan.style.flexGrow = "1";
          nameSpan.style.cursor = "pointer";
          nameSpan.onclick = () => selectPlace(place);

          const deleteBtn = document.createElement("button");
          deleteBtn.textContent = "åˆªé™¤";
          deleteBtn.className = "deleteBtn";
          deleteBtn.onclick = (e) => {
            e.stopPropagation();
            deletePlace(place);
          };

          li.appendChild(nameSpan);
          li.appendChild(deleteBtn);
          listEl.appendChild(li);
        });
      }

      function filterPlaces() {
        const keyword = document.getElementById("searchInput").value.toLowerCase();
        const filtered = places.filter(name => name.toLowerCase().includes(keyword));
        displayPlaces(filtered);
      }

      function selectPlace(name) {
        selectedPlace = name;
        document.getElementById("selectedPlaceName").textContent = `ğŸ“ ${name}`;
        document.getElementById("infoPanel").style.display = "block";
        document.getElementById("rating").value = "";
        document.getElementById("review").value = "";
        document.getElementById("image").value = "";
      }

      async function saveReview() {
        const rating = document.getElementById("rating").value;
        const review = document.getElementById("review").value;
        const imageInput = document.getElementById("image");
        const imageFile = imageInput.files[0];

        if (!selectedPlace || !rating || !review) {
          alert("è«‹è¼¸å…¥å®Œæ•´çš„è©•åˆ†èˆ‡å¿ƒå¾—ï¼");
          return;
        }

        const reader = new FileReader();
        reader.onload = async function () {
          const imageData = imageFile ? reader.result : null;
          try {
            const docRef = await db.collection("reviews").add({
              name: selectedPlace,
              rating: parseFloat(rating),
              review: review,
              image: imageData
            });

            savedReviews.push({
              id: docRef.id,
              name: selectedPlace,
              rating: parseFloat(rating),
              review,
              image: imageData
            });

            renderReviews();
            updatePlacesFromReviews();

            alert(`âœ… å·²å„²å­˜\nåº—å®¶ï¼š${selectedPlace}\nè©•åˆ†ï¼š${rating}\nå¿ƒå¾—ï¼š${review}`);

            document.getElementById("rating").value = "";
            document.getElementById("review").value = "";
            document.getElementById("image").value = "";
            document.getElementById("infoPanel").style.display = "none";
          } catch (e) {
            alert("å„²å­˜å¤±æ•—ï¼š" + e.message);
          }
        };

        if (imageFile) {
          reader.readAsDataURL(imageFile);
        } else {
          reader.onload();
        }
      }

      async function deleteReviewById(id) {
        await db.collection("reviews").doc(id).delete();
        savedReviews = savedReviews.filter(r => r.id !== id);
        renderReviews();
        updatePlacesFromReviews();
      }

      function deletePlace(name) {
        if (confirm(`ä½ ç¢ºå®šè¦åˆªé™¤ã€Œ${name}ã€å—ï¼Ÿ`)) {
          // åˆªé™¤è©²é¤å»³çš„æ‰€æœ‰è©•è«–
          const toDelete = savedReviews.filter(r => r.name === name);
          Promise.all(toDelete.map(r => deleteReviewById(r.id))).then(() => {
            // é‡æ–°æ•´ç†
            renderReviews();
            updatePlacesFromReviews();
            document.getElementById("infoPanel").style.display = "none";
          });
        }
      }

      function addPlace() {
        const newName = document.getElementById("newPlaceInput").value.trim();
        if (newName === "") {
          alert("è«‹è¼¸å…¥é¤å»³åç¨±ï¼");
          return;
        }
        if (places.includes(newName)) {
          alert("æ­¤é¤å»³å·²å­˜åœ¨ï¼");
          return;
        }
        places.push(newName);
        document.getElementById("newPlaceInput").value = "";
        filterPlaces();
      }

      function renderReviews() {
        const reviewList = document.getElementById("reviewList");
        reviewList.innerHTML = "";

        const grouped = {};
        savedReviews.forEach(r => {
          if (!grouped[r.name]) grouped[r.name] = [];
          grouped[r.name].push(r);
        });

        for (let name in grouped) {
          const reviews = grouped[name];
          const avg = (
            reviews.reduce((sum, r) => sum + r.rating, 0) / reviews.length
          ).toFixed(1);

          const header = document.createElement("li");
          header.innerHTML = `<strong>ğŸ´ ${name}ï½œå¹³å‡è©•åˆ†ï¼š${avg}</strong>`;
          reviewList.appendChild(header);

          reviews.forEach((r) => {
            const li = document.createElement("li");
            li.innerHTML = `â­ è©•åˆ†ï¼š${r.rating}ï½œå¿ƒå¾—ï¼š${r.review}`;

            if (r.image) {
              const img = document.createElement("img");
              img.src = r.image;
              img.className = "thumbnail";
              li.appendChild(img);
            }

            const delBtn = document.createElement("button");
            delBtn.textContent = "åˆªé™¤";
            delBtn.style.marginLeft = "10px";
            delBtn.onclick = () => {
              deleteReviewById(r.id);
            };

            li.appendChild(delBtn);
            reviewList.appendChild(li);
          });
        }
      }

      function updatePlacesFromReviews() {
        const restaurantSet = new Set(savedReviews.map(r => r.name));
        places = Array.from(restaurantSet);
        filterPlaces();
      }

      async function loadReviewsFromFirestore() {
        savedReviews = [];
        const querySnapshot = await db.collection("reviews").get();
        querySnapshot.forEach(doc => {
          savedReviews.push({ id: doc.id, ...doc.data() });
        });
        renderReviews();
        updatePlacesFromReviews();
      }

      // é é¢è¼‰å…¥æ™‚ï¼Œè®€å– Firestore è³‡æ–™
      loadReviewsFromFirestore();
    </script>
</body>
</html>
